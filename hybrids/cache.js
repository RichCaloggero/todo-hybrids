import * as emitter from "./emitter.js";
var entries = new WeakMap();
export function getEntry(target, key) {
  var targetMap = entries.get(target);

  if (!targetMap) {
    targetMap = new Map();
    entries.set(target, targetMap);
  }

  var entry = targetMap.get(key);

  if (!entry) {
    entry = {
      target: target,
      key: key,
      value: undefined,
      contexts: undefined,
      deps: undefined,
      state: 0,
      checksum: 0,
      observed: false
    };
    targetMap.set(key, entry);
  }

  return entry;
}
export function getEntries(target) {
  var result = [];
  var targetMap = entries.get(target);

  if (targetMap) {
    targetMap.forEach(function (entry) {
      result.push(entry);
    });
  }

  return result;
}

function calculateChecksum(entry) {
  var checksum = entry.state;

  if (entry.deps) {
    entry.deps.forEach(function (depEntry) {
      checksum += depEntry.state;
    });
  }

  return checksum;
}

function dispatchDeep(entry) {
  if (entry.observed) emitter.dispatch(entry);
  if (entry.contexts) entry.contexts.forEach(dispatchDeep);
}

function restoreDeepDeps(entry, deps) {
  if (deps) {
    deps.forEach(function (depEntry) {
      entry.deps.add(depEntry);

      if (entry.observed) {
        /* istanbul ignore if */
        if (!depEntry.contexts) depEntry.contexts = new Set();
        depEntry.contexts.add(entry);
      }

      restoreDeepDeps(entry, depEntry.deps);
    });
  }
}

var contextStack = new Set();
export function get(target, key, getter, validate) {
  var entry = getEntry(target, key);

  if (contextStack.size && contextStack.has(entry)) {
    throw Error("Circular get invocation is forbidden: '".concat(key, "'"));
  }

  contextStack.forEach(function (context) {
    if (!context.deps) context.deps = new Set();
    context.deps.add(entry);

    if (context.observed) {
      if (!entry.contexts) entry.contexts = new Set();
      entry.contexts.add(context);
    }
  });

  if ((validate && validate(entry.value) || !validate) && entry.checksum && entry.checksum === calculateChecksum(entry)) {
    return entry.value;
  }

  try {
    contextStack.add(entry);

    if (entry.observed && entry.deps && entry.deps.size) {
      entry.deps.forEach(function (depEntry) {
        /* istanbul ignore else */
        if (depEntry.contexts) depEntry.contexts.delete(entry);
      });
    }

    entry.deps = undefined;
    var nextValue = getter(target, entry.value);

    if (entry.deps) {
      entry.deps.forEach(function (depEntry) {
        restoreDeepDeps(entry, depEntry.deps);
      });
    }

    if (nextValue !== entry.value) {
      entry.state += 1;
      entry.value = nextValue;
      dispatchDeep(entry);
    }

    entry.checksum = calculateChecksum(entry);
    contextStack.delete(entry);
  } catch (e) {
    entry.checksum = 0;
    contextStack.delete(entry);
    contextStack.forEach(function (context) {
      context.deps.delete(entry);
      if (context.observed) entry.contexts.delete(context);
    });
    throw e;
  }

  return entry.value;
}
export function set(target, key, setter, value) {
  var entry = getEntry(target, key);
  var newValue = setter(target, value, entry.value);

  if (newValue !== entry.value) {
    entry.checksum = 0;
    entry.state += 1;
    entry.value = newValue;
    dispatchDeep(entry);
  }
}
var gcList = new Set();

function deleteEntry(entry) {
  if (!gcList.size) {
    requestAnimationFrame(function () {
      gcList.forEach(function (e) {
        if (!e.contexts || e.contexts && e.contexts.size === 0) {
          var targetMap = entries.get(e.target);
          targetMap.delete(e.key);
        }
      });
      gcList.clear();
    });
  }

  gcList.add(entry);
}

function invalidateEntry(entry, clearValue, deleteValue) {
  entry.checksum = 0;
  entry.state += 1;
  dispatchDeep(entry);
  if (deleteValue) deleteEntry(entry);

  if (clearValue) {
    entry.value = undefined;
  }
}

export function invalidate(target, key, clearValue, deleteValue) {
  if (contextStack.size) {
    throw Error("Invalidating property in chain of get calls is forbidden: '".concat(key, "'"));
  }

  var entry = getEntry(target, key);
  invalidateEntry(entry, clearValue, deleteValue);
}
export function invalidateAll(target, clearValue, deleteValue) {
  if (contextStack.size) {
    throw Error("Invalidating all properties in chain of get calls is forbidden");
  }

  var targetMap = entries.get(target);

  if (targetMap) {
    targetMap.forEach(function (entry) {
      invalidateEntry(entry, clearValue, deleteValue);
    });
  }
}
export function observe(target, key, getter, fn) {
  var entry = getEntry(target, key);
  entry.observed = true;
  var lastValue;
  var unsubscribe = emitter.subscribe(entry, function () {
    var value = get(target, key, getter);

    if (value !== lastValue) {
      fn(target, value, lastValue);
      lastValue = value;
    }
  });

  if (entry.deps) {
    entry.deps.forEach(function (depEntry) {
      /* istanbul ignore else */
      if (!depEntry.contexts) depEntry.contexts = new Set();
      depEntry.contexts.add(entry);
    });
  }

  return function unobserve() {
    unsubscribe();
    entry.observed = false;

    if (entry.deps && entry.deps.size) {
      entry.deps.forEach(function (depEntry) {
        /* istanbul ignore else */
        if (depEntry.contexts) depEntry.contexts.delete(entry);
      });
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWNoZS5qcyJdLCJuYW1lcyI6WyJlbWl0dGVyIiwiZW50cmllcyIsIldlYWtNYXAiLCJnZXRFbnRyeSIsInRhcmdldCIsImtleSIsInRhcmdldE1hcCIsImdldCIsIk1hcCIsInNldCIsImVudHJ5IiwidmFsdWUiLCJ1bmRlZmluZWQiLCJjb250ZXh0cyIsImRlcHMiLCJzdGF0ZSIsImNoZWNrc3VtIiwib2JzZXJ2ZWQiLCJnZXRFbnRyaWVzIiwicmVzdWx0IiwiZm9yRWFjaCIsInB1c2giLCJjYWxjdWxhdGVDaGVja3N1bSIsImRlcEVudHJ5IiwiZGlzcGF0Y2hEZWVwIiwiZGlzcGF0Y2giLCJyZXN0b3JlRGVlcERlcHMiLCJhZGQiLCJTZXQiLCJjb250ZXh0U3RhY2siLCJnZXR0ZXIiLCJ2YWxpZGF0ZSIsInNpemUiLCJoYXMiLCJFcnJvciIsImNvbnRleHQiLCJkZWxldGUiLCJuZXh0VmFsdWUiLCJlIiwic2V0dGVyIiwibmV3VmFsdWUiLCJnY0xpc3QiLCJkZWxldGVFbnRyeSIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsImNsZWFyIiwiaW52YWxpZGF0ZUVudHJ5IiwiY2xlYXJWYWx1ZSIsImRlbGV0ZVZhbHVlIiwiaW52YWxpZGF0ZSIsImludmFsaWRhdGVBbGwiLCJvYnNlcnZlIiwiZm4iLCJsYXN0VmFsdWUiLCJ1bnN1YnNjcmliZSIsInN1YnNjcmliZSIsInVub2JzZXJ2ZSJdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLQSxPQUFaLE1BQXlCLGNBQXpCO0FBRUEsSUFBTUMsT0FBTyxHQUFHLElBQUlDLE9BQUosRUFBaEI7QUFDQSxPQUFPLFNBQVNDLFFBQVQsQ0FBa0JDLE1BQWxCLEVBQTBCQyxHQUExQixFQUErQjtBQUNwQyxNQUFJQyxTQUFTLEdBQUdMLE9BQU8sQ0FBQ00sR0FBUixDQUFZSCxNQUFaLENBQWhCOztBQUNBLE1BQUksQ0FBQ0UsU0FBTCxFQUFnQjtBQUNkQSxJQUFBQSxTQUFTLEdBQUcsSUFBSUUsR0FBSixF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QXRCO0FBQ0QsS0FKRDtBQUtEOztBQUVELFNBQU8sU0FBUzZDLFNBQVQsR0FBcUI7QUFDMUJGLElBQUFBLFdBQVc7QUFDWDNDLElBQUFBLEtBQUssQ0FBQ08sUUFBTixHQUFpQixLQUFqQjs7QUFDQSxRQUFJUCxLQUFLLENBQUNJLElBQU4sSUFBY0osS0FBSyxDQUFDSSxJQUFOLENBQVdrQixJQUE3QixFQUFtQztBQUNqQ3RCLE1BQUFBLEtBQUssQ0FBQ0ksSUFBTixDQUFXTSxPQUFYLENBQW1CLFVBQUFHLFFBQVEsRUFBSTtBQUM3QjtBQUNBLFlBQUlBLFFBQVEsQ0FBQ1YsUUFBYixFQUF1QlUsUUFBUSxDQUFDVixRQUFULENBQWtCdUIsTUFBbEIsQ0FBeUIxQixLQUF6QjtBQUN4QixPQUhEO0FBSUQ7QUFDRixHQVREO0FBVUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBlbWl0dGVyIGZyb20gXCIuL2VtaXR0ZXIuanNcIjtcblxuY29uc3QgZW50cmllcyA9IG5ldyBXZWFrTWFwKCk7XG5leHBvcnQgZnVuY3Rpb24gZ2V0RW50cnkodGFyZ2V0LCBrZXkpIHtcbiAgbGV0IHRhcmdldE1hcCA9IGVudHJpZXMuZ2V0KHRhcmdldCk7XG4gIGlmICghdGFyZ2V0TWFwKSB7XG4gICAgdGFyZ2V0TWFwID0gbmV3IE1hcCgpO1xuICAgIGVudHJpZXMuc2V0KHRhcmdldCwgdGFyZ2V0TWFwKTtcbiAgfVxuXG4gIGxldCBlbnRyeSA9IHRhcmdldE1hcC5nZXQoa2V5KTtcblxuICBpZiAoIWVudHJ5KSB7XG4gICAgZW50cnkgPSB7XG4gICAgICB0YXJnZXQsXG4gICAgICBrZXksXG4gICAgICB2YWx1ZTogdW5kZWZpbmVkLFxuICAgICAgY29udGV4dHM6IHVuZGVmaW5lZCxcbiAgICAgIGRlcHM6IHVuZGVmaW5lZCxcbiAgICAgIHN0YXRlOiAwLFxuICAgICAgY2hlY2tzdW06IDAsXG4gICAgICBvYnNlcnZlZDogZmFsc2UsXG4gICAgfTtcbiAgICB0YXJnZXRNYXAuc2V0KGtleSwgZW50cnkpO1xuICB9XG5cbiAgcmV0dXJuIGVudHJ5O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RW50cmllcyh0YXJnZXQpIHtcbiAgY29uc3QgcmVzdWx0ID0gW107XG4gIGNvbnN0IHRhcmdldE1hcCA9IGVudHJpZXMuZ2V0KHRhcmdldCk7XG4gIGlmICh0YXJnZXRNYXApIHtcbiAgICB0YXJnZXRNYXAuZm9yRWFjaChlbnRyeSA9PiB7XG4gICAgICByZXN1bHQucHVzaChlbnRyeSk7XG4gICAgfSk7XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlQ2hlY2tzdW0oZW50cnkpIHtcbiAgbGV0IGNoZWNrc3VtID0gZW50cnkuc3RhdGU7XG4gIGlmIChlbnRyeS5kZXBzKSB7XG4gICAgZW50cnkuZGVwcy5mb3JFYWNoKGRlcEVudHJ5ID0+IHtcbiAgICAgIGNoZWNrc3VtICs9IGRlcEVudHJ5LnN0YXRlO1xuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIGNoZWNrc3VtO1xufVxuXG5mdW5jdGlvbiBkaXNwYXRjaERlZXAoZW50cnkpIHtcbiAgaWYgKGVudHJ5Lm9ic2VydmVkKSBlbWl0dGVyLmRpc3BhdGNoKGVudHJ5KTtcbiAgaWYgKGVudHJ5LmNvbnRleHRzKSBlbnRyeS5jb250ZXh0cy5mb3JFYWNoKGRpc3BhdGNoRGVlcCk7XG59XG5cbmZ1bmN0aW9uIHJlc3RvcmVEZWVwRGVwcyhlbnRyeSwgZGVwcykge1xuICBpZiAoZGVwcykge1xuICAgIGRlcHMuZm9yRWFjaChkZXBFbnRyeSA9PiB7XG4gICAgICBlbnRyeS5kZXBzLmFkZChkZXBFbnRyeSk7XG5cbiAgICAgIGlmIChlbnRyeS5vYnNlcnZlZCkge1xuICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi9cbiAgICAgICAgaWYgKCFkZXBFbnRyeS5jb250ZXh0cykgZGVwRW50cnkuY29udGV4dHMgPSBuZXcgU2V0KCk7XG4gICAgICAgIGRlcEVudHJ5LmNvbnRleHRzLmFkZChlbnRyeSk7XG4gICAgICB9XG5cbiAgICAgIHJlc3RvcmVEZWVwRGVwcyhlbnRyeSwgZGVwRW50cnkuZGVwcyk7XG4gICAgfSk7XG4gIH1cbn1cblxuY29uc3QgY29udGV4dFN0YWNrID0gbmV3IFNldCgpO1xuZXhwb3J0IGZ1bmN0aW9uIGdldCh0YXJnZXQsIGtleSwgZ2V0dGVyLCB2YWxpZGF0ZSkge1xuICBjb25zdCBlbnRyeSA9IGdldEVudHJ5KHRhcmdldCwga2V5KTtcblxuICBpZiAoY29udGV4dFN0YWNrLnNpemUgJiYgY29udGV4dFN0YWNrLmhhcyhlbnRyeSkpIHtcbiAgICB0aHJvdyBFcnJvcihgQ2lyY3VsYXIgZ2V0IGludm9jYXRpb24gaXMgZm9yYmlkZGVuOiAnJHtrZXl9J2ApO1xuICB9XG5cbiAgY29udGV4dFN0YWNrLmZvckVhY2goY29udGV4dCA9PiB7XG4gICAgaWYgKCFjb250ZXh0LmRlcHMpIGNvbnRleHQuZGVwcyA9IG5ldyBTZXQoKTtcbiAgICBjb250ZXh0LmRlcHMuYWRkKGVudHJ5KTtcblxuICAgIGlmIChjb250ZXh0Lm9ic2VydmVkKSB7XG4gICAgICBpZiAoIWVudHJ5LmNvbnRleHRzKSBlbnRyeS5jb250ZXh0cyA9IG5ldyBTZXQoKTtcbiAgICAgIGVudHJ5LmNvbnRleHRzLmFkZChjb250ZXh0KTtcbiAgICB9XG4gIH0pO1xuXG4gIGlmIChcbiAgICAoKHZhbGlkYXRlICYmIHZhbGlkYXRlKGVudHJ5LnZhbHVlKSkgfHwgIXZhbGlkYXRlKSAmJlxuICAgIGVudHJ5LmNoZWNrc3VtICYmXG4gICAgZW50cnkuY2hlY2tzdW0gPT09IGNhbGN1bGF0ZUNoZWNrc3VtKGVudHJ5KVxuICApIHtcbiAgICByZXR1cm4gZW50cnkudmFsdWU7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnRleHRTdGFjay5hZGQoZW50cnkpO1xuXG4gICAgaWYgKGVudHJ5Lm9ic2VydmVkICYmIGVudHJ5LmRlcHMgJiYgZW50cnkuZGVwcy5zaXplKSB7XG4gICAgICBlbnRyeS5kZXBzLmZvckVhY2goZGVwRW50cnkgPT4ge1xuICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqL1xuICAgICAgICBpZiAoZGVwRW50cnkuY29udGV4dHMpIGRlcEVudHJ5LmNvbnRleHRzLmRlbGV0ZShlbnRyeSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBlbnRyeS5kZXBzID0gdW5kZWZpbmVkO1xuICAgIGNvbnN0IG5leHRWYWx1ZSA9IGdldHRlcih0YXJnZXQsIGVudHJ5LnZhbHVlKTtcblxuICAgIGlmIChlbnRyeS5kZXBzKSB7XG4gICAgICBlbnRyeS5kZXBzLmZvckVhY2goZGVwRW50cnkgPT4ge1xuICAgICAgICByZXN0b3JlRGVlcERlcHMoZW50cnksIGRlcEVudHJ5LmRlcHMpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKG5leHRWYWx1ZSAhPT0gZW50cnkudmFsdWUpIHtcbiAgICAgIGVudHJ5LnN0YXRlICs9IDE7XG4gICAgICBlbnRyeS52YWx1ZSA9IG5leHRWYWx1ZTtcblxuICAgICAgZGlzcGF0Y2hEZWVwKGVudHJ5KTtcbiAgICB9XG5cbiAgICBlbnRyeS5jaGVja3N1bSA9IGNhbGN1bGF0ZUNoZWNrc3VtKGVudHJ5KTtcbiAgICBjb250ZXh0U3RhY2suZGVsZXRlKGVudHJ5KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGVudHJ5LmNoZWNrc3VtID0gMDtcblxuICAgIGNvbnRleHRTdGFjay5kZWxldGUoZW50cnkpO1xuICAgIGNvbnRleHRTdGFjay5mb3JFYWNoKGNvbnRleHQgPT4ge1xuICAgICAgY29udGV4dC5kZXBzLmRlbGV0ZShlbnRyeSk7XG4gICAgICBpZiAoY29udGV4dC5vYnNlcnZlZCkgZW50cnkuY29udGV4dHMuZGVsZXRlKGNvbnRleHQpO1xuICAgIH0pO1xuXG4gICAgdGhyb3cgZTtcbiAgfVxuXG4gIHJldHVybiBlbnRyeS52YWx1ZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNldCh0YXJnZXQsIGtleSwgc2V0dGVyLCB2YWx1ZSkge1xuICBjb25zdCBlbnRyeSA9IGdldEVudHJ5KHRhcmdldCwga2V5KTtcbiAgY29uc3QgbmV3VmFsdWUgPSBzZXR0ZXIodGFyZ2V0LCB2YWx1ZSwgZW50cnkudmFsdWUpO1xuXG4gIGlmIChuZXdWYWx1ZSAhPT0gZW50cnkudmFsdWUpIHtcbiAgICBlbnRyeS5jaGVja3N1bSA9IDA7XG4gICAgZW50cnkuc3RhdGUgKz0gMTtcbiAgICBlbnRyeS52YWx1ZSA9IG5ld1ZhbHVlO1xuXG4gICAgZGlzcGF0Y2hEZWVwKGVudHJ5KTtcbiAgfVxufVxuXG5jb25zdCBnY0xpc3QgPSBuZXcgU2V0KCk7XG5mdW5jdGlvbiBkZWxldGVFbnRyeShlbnRyeSkge1xuICBpZiAoIWdjTGlzdC5zaXplKSB7XG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgIGdjTGlzdC5mb3JFYWNoKGUgPT4ge1xuICAgICAgICBpZiAoIWUuY29udGV4dHMgfHwgKGUuY29udGV4dHMgJiYgZS5jb250ZXh0cy5zaXplID09PSAwKSkge1xuICAgICAgICAgIGNvbnN0IHRhcmdldE1hcCA9IGVudHJpZXMuZ2V0KGUudGFyZ2V0KTtcbiAgICAgICAgICB0YXJnZXRNYXAuZGVsZXRlKGUua2V5KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBnY0xpc3QuY2xlYXIoKTtcbiAgICB9KTtcbiAgfVxuXG4gIGdjTGlzdC5hZGQoZW50cnkpO1xufVxuXG5mdW5jdGlvbiBpbnZhbGlkYXRlRW50cnkoZW50cnksIGNsZWFyVmFsdWUsIGRlbGV0ZVZhbHVlKSB7XG4gIGVudHJ5LmNoZWNrc3VtID0gMDtcbiAgZW50cnkuc3RhdGUgKz0gMTtcblxuICBkaXNwYXRjaERlZXAoZW50cnkpO1xuICBpZiAoZGVsZXRlVmFsdWUpIGRlbGV0ZUVudHJ5KGVudHJ5KTtcblxuICBpZiAoY2xlYXJWYWx1ZSkge1xuICAgIGVudHJ5LnZhbHVlID0gdW5kZWZpbmVkO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpbnZhbGlkYXRlKHRhcmdldCwga2V5LCBjbGVhclZhbHVlLCBkZWxldGVWYWx1ZSkge1xuICBpZiAoY29udGV4dFN0YWNrLnNpemUpIHtcbiAgICB0aHJvdyBFcnJvcihcbiAgICAgIGBJbnZhbGlkYXRpbmcgcHJvcGVydHkgaW4gY2hhaW4gb2YgZ2V0IGNhbGxzIGlzIGZvcmJpZGRlbjogJyR7a2V5fSdgLFxuICAgICk7XG4gIH1cblxuICBjb25zdCBlbnRyeSA9IGdldEVudHJ5KHRhcmdldCwga2V5KTtcbiAgaW52YWxpZGF0ZUVudHJ5KGVudHJ5LCBjbGVhclZhbHVlLCBkZWxldGVWYWx1ZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpbnZhbGlkYXRlQWxsKHRhcmdldCwgY2xlYXJWYWx1ZSwgZGVsZXRlVmFsdWUpIHtcbiAgaWYgKGNvbnRleHRTdGFjay5zaXplKSB7XG4gICAgdGhyb3cgRXJyb3IoXG4gICAgICBcIkludmFsaWRhdGluZyBhbGwgcHJvcGVydGllcyBpbiBjaGFpbiBvZiBnZXQgY2FsbHMgaXMgZm9yYmlkZGVuXCIsXG4gICAgKTtcbiAgfVxuXG4gIGNvbnN0IHRhcmdldE1hcCA9IGVudHJpZXMuZ2V0KHRhcmdldCk7XG4gIGlmICh0YXJnZXRNYXApIHtcbiAgICB0YXJnZXRNYXAuZm9yRWFjaChlbnRyeSA9PiB7XG4gICAgICBpbnZhbGlkYXRlRW50cnkoZW50cnksIGNsZWFyVmFsdWUsIGRlbGV0ZVZhbHVlKTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gb2JzZXJ2ZSh0YXJnZXQsIGtleSwgZ2V0dGVyLCBmbikge1xuICBjb25zdCBlbnRyeSA9IGdldEVudHJ5KHRhcmdldCwga2V5KTtcbiAgZW50cnkub2JzZXJ2ZWQgPSB0cnVlO1xuXG4gIGxldCBsYXN0VmFsdWU7XG4gIGNvbnN0IHVuc3Vic2NyaWJlID0gZW1pdHRlci5zdWJzY3JpYmUoZW50cnksICgpID0+IHtcbiAgICBjb25zdCB2YWx1ZSA9IGdldCh0YXJnZXQsIGtleSwgZ2V0dGVyKTtcbiAgICBpZiAodmFsdWUgIT09IGxhc3RWYWx1ZSkge1xuICAgICAgZm4odGFyZ2V0LCB2YWx1ZSwgbGFzdFZhbHVlKTtcbiAgICAgIGxhc3RWYWx1ZSA9IHZhbHVlO1xuICAgIH1cbiAgfSk7XG5cbiAgaWYgKGVudHJ5LmRlcHMpIHtcbiAgICBlbnRyeS5kZXBzLmZvckVhY2goZGVwRW50cnkgPT4ge1xuICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi9cbiAgICAgIGlmICghZGVwRW50cnkuY29udGV4dHMpIGRlcEVudHJ5LmNvbnRleHRzID0gbmV3IFNldCgpO1xuICAgICAgZGVwRW50cnkuY29udGV4dHMuYWRkKGVudHJ5KTtcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiBmdW5jdGlvbiB1bm9ic2VydmUoKSB7XG4gICAgdW5zdWJzY3JpYmUoKTtcbiAgICBlbnRyeS5vYnNlcnZlZCA9IGZhbHNlO1xuICAgIGlmIChlbnRyeS5kZXBzICYmIGVudHJ5LmRlcHMuc2l6ZSkge1xuICAgICAgZW50cnkuZGVwcy5mb3JFYWNoKGRlcEVudHJ5ID0+IHtcbiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi9cbiAgICAgICAgaWYgKGRlcEVudHJ5LmNvbnRleHRzKSBkZXBFbnRyeS5jb250ZXh0cy5kZWxldGUoZW50cnkpO1xuICAgICAgfSk7XG4gICAgfVxuICB9O1xufVxuIl19